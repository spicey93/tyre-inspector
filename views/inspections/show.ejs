<!-- views/inspections/show.ejs -->
<!DOCTYPE html>
<html lang="en" class="h-full bg-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inspection <%= inspection.code %></title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* ---------- Screen/Print visibility ---------- */
    .screen-only { display: block; }
    .print-only  { display: none; }

    /* Strong print clamp: only .print-root becomes visible on paper */
    @media print {
      @page { size: A4 portrait; margin: 12mm; }
      body * { visibility: hidden !important; }
      .print-root, .print-root * { visibility: visible !important; }
      .print-root { position: relative !important; }
      .screen-only { display: none !important; }
      .wheel-caption { display: none !important; }
    }

    /* Car & wheel styling */
    .car-wrap{ position:relative; max-width:280px; margin-inline:auto; }
    @media (min-width: 640px){ .car-wrap{ max-width:320px; } }
    @media (min-width: 1024px){ .car-wrap{ max-width:360px; } }
    .car-svg{ width:100%; height:auto; display:block; }

    .wheel{
      position:absolute; width:22%; aspect-ratio:1/1; border-radius:9999px;
      transform: translate(-50%,-50%);
      border:2px solid #94a3b8; background:#fff;
      display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:.8rem; color:#0f172a;
      transition: box-shadow .15s, transform .05s, background-color .15s, border-color .15s, color .15s;
      cursor:pointer; user-select:none;
    }
    .wheel.ok    { border-color:#15803d; background:#e7f6ec; color:#14532d; }
    .wheel.adv   { border-color:#f59e0b; background:#fff7d6; color:#7c5206; }
    .wheel.fail  { border-color:#e11d48; background:#fde2e4; color:#7f1d1d; }
    .wheel.active{ box-shadow: inset 0 0 0 .6rem rgba(14,165,233,.35); }
    .wheel-print{
      position:absolute; width:22%; aspect-ratio:1/1; border-radius:9999px;
      transform: translate(-50%,-50%);
      border:2px solid #94a3b8; background:#fff;
      display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:10px; color:#0f172a;
    }
    .wheel-print.ok   { border-color:#15803d; background:#e7f6ec; color:#14532d; }
    .wheel-print.adv  { border-color:#f59e0b; background:#fff7d6; color:#7c5206; }
    .wheel-print.fail { border-color:#e11d48; background:#fde2e4; color:#7f1d1d; }

    /* Print table visuals */
    @media print {
      .print-table { border-collapse: collapse; width: 100%; }
      .print-table th, .print-table td { border: 1px solid #cbd5e1; padding: 6px 8px; vertical-align: top; }
      .print-muted { color: #475569; }
    }
  </style>
</head>
<body class="h-full">
  <div class="mx-auto max-w-5xl px-4 py-6">

    <!-- Top actions (screen only) -->
    <div class="mb-3 screen-only">
      <a href="/" class="inline-flex items-center gap-2 text-slate-600 hover:text-slate-800">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M15 19l-7-7 7-7"/></svg>
        Home
      </a>
    </div>

    <%
      function fmt(v){ return (v ?? "") === "" ? "—" : v; }
      function plainCondition(node){
        const c = node?.condition ? String(node.condition).toLowerCase() : null;
        if (c === "ok" || c === "advisory" || c === "fail") return c;
        const t = node?.treadDepth || {};
        const vals = [t.inner, t.middle, t.outer].map(Number).filter(n => !isNaN(n));
        if (!vals.length) return "—";
        if (vals.some(v => v < 2.5)) return "fail";
        if (vals.some(v => v < 4)) return "advisory";
        return "ok";
      }
      const tyresPrint = {
        "Offside Front (OSF)": inspection.offside?.front || {},
        "Nearside Front (NSF)": inspection.nearside?.front || {},
        "Offside Rear (OSR)":  inspection.offside?.rear  || {},
        "Nearside Rear (NSR)": inspection.nearside?.rear || {},
      };
    %>

    <!-- PRINT ROOT -->
    <section class="print-root">
      <!-- Header -->
      <div class="mb-3">
        <h1 class="text-xl font-semibold">Tyre Inspection Report</h1>
        <div class="print-muted text-sm">
          <span><strong>Code:</strong> <%= inspection.code %></span>
          &nbsp;|&nbsp;<span><strong>VRM:</strong> <%= inspection.vrm %></span>
          <% if (typeof inspection.mileage === "number") { %>
            &nbsp;|&nbsp;<span><strong>Mileage:</strong> <%= inspection.mileage %></span>
          <% } %>
          <% if (inspection.createdAt) { %>
            &nbsp;|&nbsp;<span><strong>Date:</strong> <%= new Date(inspection.createdAt).toLocaleString() %></span>
          <% } %>
        </div>
        <% if (inspection.vehicle) { %>
          <div class="print-muted text-sm">
            <strong>Vehicle:</strong>
            <%= inspection.vehicle.make %> <%= inspection.vehicle.model %>
            <% if (inspection.vehicle.year) { %>(<%= inspection.vehicle.year %>)<% } %>
            <% if (inspection.vehicle.torque) { %> &nbsp;|&nbsp; <strong>Torque:</strong> <%= inspection.vehicle.torque %> Nm <% } %>
          </div>
        <% } %>
      </div>

      <!-- Responsive tyre details -->
      <!-- Mobile: cards -->
      <div class="space-y-3 md:hidden print:hidden">
        <% for (const [pos, t] of Object.entries(tyresPrint)) { %>
          <div class="rounded-xl border border-slate-200 bg-white p-3">
            <div class="flex items-start justify-between">
              <div class="font-semibold text-slate-900"><%= pos %></div>
              <div class="text-xs capitalize px-2 py-0.5 rounded-full bg-slate-100 text-slate-700">
                <%= plainCondition(t) %>
              </div>
            </div>
            <dl class="mt-2 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
              <dt class="text-slate-500">Size</dt>
              <dd class="text-slate-900 text-right"><%= fmt(t.size) %></dd>
              <dt class="text-slate-500">Brand</dt>
              <dd class="text-slate-900 text-right"><%= fmt(t.brand) %></dd>
              <dt class="text-slate-500">Model</dt>
              <dd class="text-slate-900 text-right"><%= fmt(t.model) %></dd>
              <dt class="text-slate-500">DOT</dt>
              <dd class="text-slate-900 text-right"><%= fmt(t.dot) %></dd>
              <dt class="text-slate-500">Tread</dt>
              <dd class="text-slate-900 text-right">
                <%= fmt(t?.treadDepth?.inner) %> /
                <%= fmt(t?.treadDepth?.middle) %> /
                <%= fmt(t?.treadDepth?.outer) %>
              </dd>
            </dl>
            <% if ((Array.isArray(t?.tags) && t.tags.length) || t?.notes) { %>
              <div class="mt-2 space-y-1">
                <% if (Array.isArray(t?.tags) && t.tags.length) { %>
                  <div class="text-xs"><strong>Tags:</strong> <%= t.tags.join(", ") %></div>
                <% } %>
                <% if (t?.notes) { %>
                  <div class="text-xs"><strong>Notes:</strong> <%= t.notes %></div>
                <% } %>
              </div>
            <% } %>
          </div>
        <% } %>
      </div>

      <!-- Desktop/Print: table -->
      <div class="hidden md:block">
        <div class="overflow-x-auto -mx-4 md:mx-0">
          <table class="min-w-[760px] w-full text-sm print-table hidden md:table print:table">
            <thead>
              <tr class="bg-slate-100">
                <th class="text-left px-3 py-2">Position</th>
                <th class="text-left px-3 py-2">Size</th>
                <th class="text-left px-3 py-2">Brand</th>
                <th class="text-left px-3 py-2">Model</th>
                <th class="text-left px-3 py-2">DOT</th>
                <th class="text-left px-3 py-2">Tread (In / Mid / Out)</th>
                <th class="text-left px-3 py-2">Condition</th>
              </tr>
            </thead>
            <tbody>
              <% for (const [pos, t] of Object.entries(tyresPrint)) { %>
                <tr class="border-t border-slate-200">
                  <td class="px-3 py-2"><%= pos %></td>
                  <td class="px-3 py-2"><%= fmt(t.size) %></td>
                  <td class="px-3 py-2"><%= fmt(t.brand) %></td>
                  <td class="px-3 py-2"><%= fmt(t.model) %></td>
                  <td class="px-3 py-2"><%= fmt(t.dot) %></td>
                  <td class="px-3 py-2"><%= fmt(t?.treadDepth?.inner) %> / <%= fmt(t?.treadDepth?.middle) %> / <%= fmt(t?.treadDepth?.outer) %></td>
                  <td class="px-3 py-2 capitalize"><%= plainCondition(t) %></td>
                </tr>
                <% if ((Array.isArray(t?.tags) && t.tags.length) || t?.notes) { %>
                  <tr class="border-b border-slate-200">
                    <td class="px-3 py-2 text-slate-700" colspan="7">
                      <% if (Array.isArray(t?.tags) && t.tags.length) { %>
                        <div class="mb-1"><strong>Tags:</strong> <%= t.tags.join(", ") %></div>
                      <% } %>
                      <% if (t?.notes) { %>
                        <div><strong>Notes:</strong> <%= t.notes %></div>
                      <% } %>
                    </td>
                  </tr>
                <% } %>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Print car -->
      <div class="mt-4 flex justify-center">
        <div style="position:relative; max-width:220px;">
          <svg viewBox="0 0 400 800" style="width:100%;height:auto;">
            <rect x="60" y="60" width="280" height="680" rx="40" fill="#f1f5f9" stroke="#cbd5e1"/>
            <rect x="80" y="80" width="240" height="120" rx="20" fill="#e2e8f0" />
            <rect x="80" y="600" width="240" height="120" rx="20" fill="#e2e8f0" />
            <rect x="90" y="240" width="220" height="280" rx="16" fill="#e5e7eb" />
          </svg>
          <% const wp = [
              {k:"OSF", node: tyresPrint["Offside Front (OSF)"], left:"86%", top:"19%"},
              {k:"NSF", node: tyresPrint["Nearside Front (NSF)"], left:"14%", top:"19%"},
              {k:"OSR", node: tyresPrint["Offside Rear (OSR)"],  left:"86%", top:"81%"},
              {k:"NSR", node: tyresPrint["Nearside Rear (NSR)"], left:"14%", top:"81%"},
            ];
            function cls(n){
              const c = n?.condition ? String(n.condition).toLowerCase() : null;
              if (c === "fail") return "fail";
              if (c === "advisory") return "adv";
              if (c === "ok") return "ok";
              const t = n?.treadDepth || {};
              const vals = [t.inner, t.middle, t.outer].map(Number).filter(x => !isNaN(x));
              if (vals.length){
                if (vals.some(v => v < 3)) return "fail";
                if (vals.some(v => v < 4)) return "adv";
                return "ok";
              }
              return "";
            }
          %>
          <% for (const w of wp) { %>
            <div class="wheel-print <%= cls(w.node) %>" style="left:<%= w.left %>; top:<%= w.top %>;"><%= w.k %></div>
          <% } %>
        </div>
      </div>
    </section>

    <!-- Screen actions -->
    <section class="mt-4 flex items-center gap-2 screen-only">
      <button type="button" id="copyLink"
              class="inline-flex items-center gap-2 rounded-lg border border-slate-300 px-3 py-2 text-slate-700 hover:bg-slate-50">
        Copy link
      </button>
      <button type="button" onclick="window.print()"
              class="inline-flex items-center gap-2 rounded-lg border border-slate-300 px-3 py-2 text-slate-700 hover:bg-slate-50">
        Print
      </button>
    </section>
  </div>

  <script>
    (function(){
      const btn = document.getElementById('copyLink');
      if (!btn) return;
      btn.addEventListener('click', async () => {
        const url = new URL(window.location.origin + '/inspections');
        url.searchParams.set('code', '<%= inspection.code %>');
        try {
          await navigator.clipboard.writeText(url.toString());
          btn.textContent = 'Copied!';
          setTimeout(()=> btn.textContent = 'Copy link', 1500);
        } catch {
          prompt('Copy this link:', url.toString());
        }
      });
    })();
  </script>
</body>
</html>
