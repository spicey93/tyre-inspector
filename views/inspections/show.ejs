<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Inspection <%= (inspection && inspection.code) || (code || '') %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .kv { display:flex; justify-content:space-between; gap:1rem; padding:.25rem 0; border-bottom:1px dashed #eee; }
    .kv:last-child { border-bottom:0; }
    .muted { color:#6c757d; }
    .badge-status { font-weight:600; }
    .td-mm { min-width: 3ch; display:inline-block; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-3 py-md-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h4 mb-0">Inspection</h1>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary btn-sm" href="/inspections/new">New Inspection</a>
        <a class="btn btn-primary btn-sm" href="/">Home</a>
      </div>
    </div>

    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger"><%= error %></div>
    <% } %>

    <% if (inspection) { %>
      <!-- Header card -->
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12 col-md-4">
              <div class="kv">
                <span class="muted">Code</span>
                <strong><%= inspection.code %></strong>
              </div>
              <div class="kv">
                <span class="muted">VRM</span>
                <span><%= inspection.vrm || '—' %></span>
              </div>
              <div class="kv">
                <span class="muted">Mileage</span>
                <span><%= inspection.mileage || '—' %></span>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="kv">
                <span class="muted">Created</span>
                <span>
                  <% if (inspection.createdAt) { %>
                    <%= new Date(inspection.createdAt).toLocaleString() %>
                  <% } else { %>—<% } %>
                </span>
              </div>
              <div class="kv">
                <span class="muted">Updated</span>
                <span>
                  <% if (inspection.updatedAt) { %>
                    <%= new Date(inspection.updatedAt).toLocaleString() %>
                  <% } else { %>—<% } %>
                </span>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="kv" style="border-bottom:0;">
                <span class="muted">Notes</span>
                <span class="text-end" style="max-width: 70%;">
                  <%= inspection.notes || '—' %>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <% 
        // Helpers (EJS allows inline JS)
        const tyres = inspection.tyres || {};
        const positions = [
          { key: 'nearside.front',  label: 'Nearside • Front'  },
          { key: 'nearside.rear',   label: 'Nearside • Rear'   },
          { key: 'offside.front',   label: 'Offside • Front'   },
          { key: 'offside.rear',    label: 'Offside • Rear'    },
          { key: 'spare',           label: 'Spare'             },
        ];
        function get(obj, path) {
          return path.split('.').reduce((o,k)=> (o && o[k] !== undefined) ? o[k] : undefined, obj);
        }
        function hasAnyTyreData(t) {
          if (!t || typeof t !== 'object') return false;
          const td = t.treadDepth || {};
          return Boolean(
            td.inner || td.middle || td.outer || t.psi || (t.brand && t.brand.trim()) ||
            (t.dot && t.dot.trim()) || (t.notes && t.notes.trim()) || (t.status && t.status.trim())
          );
        }
        function statusBadgeClass(s) {
          if (s === 'Bad') return 'text-bg-danger';
          if (s === 'Warning') return 'text-bg-warning';
          if (s === 'Good') return 'text-bg-success';
          return 'text-bg-secondary';
        }
      %>

      <!-- Tyres -->
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h2 class="h5 mb-0">Tyres</h2>
          </div>

          <div class="accordion" id="tyresAccordion">
            <% 
              let anyShown = false;
              positions.forEach((pos, idx) => {
                const t = get(tyres, pos.key);
                if (!hasAnyTyreData(t)) return;
                anyShown = true;
                const paneId = `pane-${idx}`;
                const headingId = `heading-${idx}`;
            %>
              <div class="accordion-item">
                <h2 class="accordion-header" id="<%= headingId %>">
                  <button class="accordion-button <%= idx ? 'collapsed' : '' %>" type="button" data-bs-toggle="collapse" data-bs-target="#<%= paneId %>" aria-expanded="<%= idx ? 'false' : 'true' %>" aria-controls="<%= paneId %>">
                    <%= pos.label %>
                    <% if (t && t.status) { %>
                      <span class="badge badge-status ms-2 <%= statusBadgeClass(t.status) %>"><%= t.status %></span>
                    <% } %>
                  </button>
                </h2>
                <div id="<%= paneId %>" class="accordion-collapse collapse <%= idx ? '' : 'show' %>" aria-labelledby="<%= headingId %>" data-bs-parent="#tyresAccordion">
                  <div class="accordion-body">
                    <div class="row g-3">
                      <div class="col-12 col-md-6">
                        <div class="card border-0">
                          <div class="card-body p-0">
                            <h6 class="text-uppercase text-muted mb-2">Tread Depth (mm)</h6>
                            <div class="d-flex flex-wrap gap-3">
                              <div>
                                <div class="muted small">Inner</div>
                                <div class="td-mm"><%= (t && t.treadDepth && t.treadDepth.inner != null) ? t.treadDepth.inner : '—' %></div>
                              </div>
                              <div>
                                <div class="muted small">Middle</div>
                                <div class="td-mm"><%= (t && t.treadDepth && t.treadDepth.middle != null) ? t.treadDepth.middle : '—' %></div>
                              </div>
                              <div>
                                <div class="muted small">Outer</div>
                                <div class="td-mm"><%= (t && t.treadDepth && t.treadDepth.outer != null) ? t.treadDepth.outer : '—' %></div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="col-12 col-md-6">
                        <div class="card border-0">
                          <div class="card-body p-0">
                            <h6 class="text-uppercase text-muted mb-2">Details</h6>
                            <div class="row g-2">
                              <div class="col-6">
                                <div class="muted small">PSI</div>
                                <div><%= (t && t.psi != null) ? t.psi : '—' %></div>
                              </div>
                              <div class="col-6">
                                <div class="muted small">DOT (WWYY)</div>
                                <div><%= (t && t.dot) ? t.dot : '—' %></div>
                              </div>
                              <div class="col-12">
                                <div class="muted small">Brand</div>
                                <div><%= (t && t.brand) ? t.brand : '—' %></div>
                              </div>
                              <div class="col-12">
                                <div class="muted small">Notes</div>
                                <div><%= (t && t.notes) ? t.notes : '—' %></div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                    </div> <!-- /row -->
                  </div>
                </div>
              </div>
            <% }); %>

            <% if (!anyShown) { %>
              <div class="text-muted">No tyre details recorded.</div>
            <% } %>
          </div>
        </div>
      </div>
    <% } else { %>
      <div class="alert alert-info">
        Provide a code in the query string to view an inspection. Example:
        <code>/inspections?code=ABC123</code>
      </div>
    <% } %>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
