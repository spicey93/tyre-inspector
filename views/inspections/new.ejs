<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Create Inspection</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .section-help { font-size:.9rem; color:#6c757d; }
    .fw-600 { font-weight: 600; }
    .form-text { margin-top: .15rem; }
    .tyre-actions { gap:.5rem }
  </style>
</head>
<body class="bg-light">
  <div class="container py-3 py-md-4">
    <div class="d-flex align-items-center mb-3">
      <h1 class="h3 mb-0">Create Inspection</h1>
      <div class="ms-auto d-flex gap-2">
        <a class="btn btn-outline-secondary btn-sm" href="/">Home</a>
      </div>
    </div>

    <!-- Flash messages (optional) -->
    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger"><%- error %></div>
    <% } %>
    <% if (typeof message !== 'undefined' && message) { %>
      <div class="alert alert-success"><%= message %></div>
    <% } %>

    <form action="/inspections" method="POST" novalidate>
      <!-- If you add CSRF later, guard it:
      <% if (typeof csrfToken !== 'undefined') { %>
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <% } %>
      -->

      <!-- Basic details -->
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h2 class="h5 mb-3">Vehicle</h2>
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label for="vrm" class="form-label">VRM</label>
              <input id="vrm" name="vrm" type="text" class="form-control" placeholder="e.g. AB12 CDE" value="<%= (data && data.vrm) || '' %>" required>
              <div class="form-text">Registration/plate number.</div>
            </div>
            <div class="col-12 col-md-6">
              <label for="mileage" class="form-label">Mileage</label>
              <input id="mileage" name="mileage" type="text" class="form-control" placeholder="e.g. 45,230" value="<%= (data && data.mileage) || '' %>">
            </div>
            <div class="col-12">
              <label for="notes" class="form-label">Inspection Notes</label>
              <textarea id="notes" name="notes" class="form-control" rows="3" placeholder="General notes about this inspection..."><%= (data && data.notes) || '' %></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Tyres -->
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h2 class="h5 mb-0">Tyres</h2>
          </div>
          <p class="section-help mb-3">Enter size, tread depths (mm), PSI, brand, DOT last-4 (WWYY), notes, and status. Use “Apply this tyre to all” to speed things up.</p>

          <% const positions = [
              { key: 'nearside.front',  label: 'Nearside • Front'  },
              { key: 'nearside.rear',   label: 'Nearside • Rear'   },
              { key: 'offside.front',   label: 'Offside • Front'   },
              { key: 'offside.rear',    label: 'Offside • Rear'    },
            ];
            const path = (k) => `tyres${k.split('.').map(p => `[${p}]`).join('')}`;
            const getVal = (obj, str) => {
              if (!obj) return '';
              return str.split('.').reduce((o, k) => (o && (k in o)) ? o[k] : '', obj) ?? '';
            };
          %>

          <div class="accordion" id="tyresAccordion">
            <% positions.forEach((pos, idx) => { 
              const paneId=`pane-${idx}`; 
              const headingId=`heading-${idx}`;
              const pre = (data && data.tyres) ? getVal(data.tyres, pos.key) : null;
            %>
              <div class="accordion-item" data-tyre="<%= pos.key %>">
                <h2 class="accordion-header" id="<%= headingId %>">
                  <button class="accordion-button <%= idx ? 'collapsed' : '' %>" type="button" data-bs-toggle="collapse" data-bs-target="#<%= paneId %>" aria-expanded="<%= idx ? 'false' : 'true' %>" aria-controls="<%= paneId %>">
                    <%= pos.label %>
                  </button>
                </h2>
                <div id="<%= paneId %>" class="accordion-collapse collapse <%= idx ? '' : 'show' %>" aria-labelledby="<%= headingId %>" data-bs-parent="#tyresAccordion">
                  <div class="accordion-body">
                    <div class="d-flex tyre-actions justify-content-end mb-2">
                      <button type="button" class="btn btn-sm btn-outline-secondary apply-this-tyre">
                        Apply this tyre to all
                      </button>
                    </div>

                    <div class="row g-3">
                      <!-- Row A: tread depths -->
                      <div class="col-12">
                        <span class="fw-600">Tread depth (mm)</span>
                      </div>
                      <div class="col-12 col-md-4">
                        <label class="form-label">Inner</label>
                        <input type="number" step="0.1" min="0" class="form-control"
                          name="<%= path(pos.key) %>[treadDepth][inner]"
                          data-field="treadDepth.inner"
                          value="<%= pre && pre.treadDepth ? (pre.treadDepth.inner ?? '') : '' %>"
                          placeholder="e.g. 7.0">
                      </div>
                      <div class="col-12 col-md-4">
                        <label class="form-label">Middle</label>
                        <input type="number" step="0.1" min="0" class="form-control"
                          name="<%= path(pos.key) %>[treadDepth][middle]"
                          data-field="treadDepth.middle"
                          value="<%= pre && pre.treadDepth ? (pre.treadDepth.middle ?? '') : '' %>"
                          placeholder="e.g. 7.0">
                      </div>
                      <div class="col-12 col-md-4">
                        <label class="form-label">Outer</label>
                        <input type="number" step="0.1" min="0" class="form-control"
                          name="<%= path(pos.key) %>[treadDepth][outer]"
                          data-field="treadDepth.outer"
                          value="<%= pre && pre.treadDepth ? (pre.treadDepth.outer ?? '') : '' %>"
                          placeholder="e.g. 6.0">
                      </div>

                      <!-- Row B: size + psi + dot (6 + 3 + 3 = 12) -->
                      <div class="col-12 col-md-6">
                        <label class="form-label">Tyre Size</label>
                        <input type="text" class="form-control"
                          name="<%= path(pos.key) %>[size]"
                          data-field="size"
                          value="<%= pre ? (pre.size ?? '') : '' %>"
                          placeholder="e.g. 205/55 R16 91V"
                          pattern="\\d{3}\\/\\d{2}\\s*R\\d{2}(\\s*\\d{2,3}[A-Z])?"
                          title="Format like 205/55 R16 91V">
                        <div class="form-text">Width/Aspect Rim (Load+Speed optional)</div>
                      </div>
                      <div class="col-6 col-md-3">
                        <label class="form-label">PSI</label>
                        <input type="number" min="0" step="0.1" class="form-control"
                          name="<%= path(pos.key) %>[psi]"
                          data-field="psi"
                          value="<%= pre ? (pre.psi ?? '') : '' %>"
                          placeholder="e.g. 32">
                      </div>
                      <div class="col-6 col-md-3">
                        <label class="form-label">DOT (WWYY)</label>
                        <input type="text" class="form-control"
                          name="<%= path(pos.key) %>[dot]"
                          data-field="dot"
                          value="<%= pre ? (pre.dot ?? '') : '' %>"
                          placeholder="e.g. 0523"
                          pattern="(0[1-9]|[1-4][0-9]|5[0-3])[0-9]{2}"
                          title="Enter 4 digits: week 01–53, then year (e.g., 0523)">
                        <div class="form-text">Last 4 digits only (week + year).</div>
                      </div>

                      <!-- Row C: brand + status (8 + 4 = 12) -->
                      <div class="col-12 col-md-8">
                        <label class="form-label">Brand</label>
                        <input type="text" class="form-control"
                          name="<%= path(pos.key) %>[brand]"
                          data-field="brand"
                          value="<%= pre ? (pre.brand ?? '') : '' %>"
                          placeholder="e.g. MICHELIN CROSSCLIMATE">
                      </div>
                      <div class="col-12 col-md-4">
                        <label class="form-label">Status</label>
                        <select class="form-select"
                          name="<%= path(pos.key) %>[status]"
                          data-field="status">
                          <option value="">— Select —</option>
                          <option value="Good"   <%= pre && pre.status === 'Good' ? 'selected' : '' %>>Good</option>
                          <option value="Warning"<%= pre && pre.status === 'Warning' ? 'selected' : '' %>>Warning</option>
                          <option value="Bad"    <%= pre && pre.status === 'Bad' ? 'selected' : '' %>>Bad</option>
                        </select>
                      </div>

                      <!-- Row D: notes (full width) -->
                      <div class="col-12">
                        <label class="form-label">Tyre Notes</label>
                        <input type="text" class="form-control"
                          name="<%= path(pos.key) %>[notes]"
                          data-field="notes"
                          value="<%= pre ? (pre.notes ?? '') : '' %>"
                          placeholder="e.g. Bald on edges">
                      </div>
                    </div> <!-- /row -->
                  </div>
                </div>
              </div>
            <% }) %>
          </div>
        </div>
      </div>

      <div class="d-flex gap-2 justify-content-end">
        <a href="/inspections" class="btn btn-outline-secondary">Cancel</a>
        <button class="btn btn-primary" type="submit">Create Inspection</button>
      </div>
    </form>
  </div>

  <!-- Bootstrap JS (Collapse/Accordion) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Apply-to-all logic -->
  <script>
    // Copies values by data-field keys, not by input order (safer)
    function copyTyreValues(sourceCard) {
      const srcMap = {};
      sourceCard.querySelectorAll('[data-field]').forEach(el => {
        const key = el.getAttribute('data-field');
        srcMap[key] = el.value;
      });

      document.querySelectorAll('.accordion-item[data-tyre]').forEach(card => {
        if (card === sourceCard) return; // skip source
        card.querySelectorAll('[data-field]').forEach(tgt => {
          const key = tgt.getAttribute('data-field');
          if (key in srcMap) {
            tgt.value = srcMap[key];
            tgt.dispatchEvent(new Event('input', { bubbles: true }));
            tgt.dispatchEvent(new Event('change', { bubbles: true }));
          }
        });
      });
    }

    // Delegate click for all "Apply this tyre to all" buttons
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.apply-this-tyre');
      if (!btn) return;
      const card = btn.closest('.accordion-item[data-tyre]');
      if (!card) return;
      copyTyreValues(card);

      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Applied!';
      setTimeout(() => { btn.disabled = false; btn.textContent = old; }, 900);
    });
  </script>
</body>
</html>
