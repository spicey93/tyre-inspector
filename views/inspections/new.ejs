<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Create Inspection</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    :root { --muted: #6c757d; }
    .section-help { font-size:.9rem; color:var(--muted); }
    .fw-600 { font-weight: 600; }
    .tyre-actions { gap:.5rem }
    .hint-badge { font-size:.7rem; }
    .sticky-cta { position: sticky; bottom: 0; z-index: 1020; }
    .sticky-cta .card { border-top-left-radius: .75rem; border-top-right-radius: .75rem; }
    .tyre-header .pos-chip { font-size:.8rem; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#f8f9fa; border:1px solid #e9ecef; border-radius:.25rem; padding:.1rem .35rem; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-3 py-md-4 pb-5"><!-- bottom padding so sticky bar won't overlap -->
    <div class="d-flex align-items-center mb-3">
      <h1 class="h3 mb-0">Create Inspection</h1>
      <div class="ms-auto d-flex gap-2">
        <a class="btn btn-outline-secondary btn-sm" href="/"><i class="bi bi-house"></i> Home</a>
      </div>
    </div>

    <!-- Flash messages (optional) -->
    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger"><%- error %></div>
    <% } %>
    <% if (typeof message !== 'undefined' && message) { %>
      <div class="alert alert-success"><%= message %></div>
    <% } %>

    <% const _data = (typeof data !== 'undefined' && data) ? data : {}; %>

    <form action="/inspections" method="POST" novalidate>
      <!-- If you add CSRF later, guard it:
      <% if (typeof csrfToken !== 'undefined') { %>
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <% } %>
      -->

      <!-- Vehicle -->
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h2 class="h5 mb-0">Vehicle</h2>
            <span class="badge text-bg-light hint-badge"><i class="bi bi-info-circle"></i> VRM required</span>
          </div>

          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label for="vrm" class="form-label">VRM</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-car-front"></i></span>
                <input id="vrm" name="vrm" type="text" class="form-control" placeholder="e.g. AB12 CDE" value="<%= _data.vrm || '' %>" required>
              </div>
              <div class="form-text">Registration/plate number.</div>
            </div>

            <div class="col-12 col-md-6">
              <label for="mileage" class="form-label">Mileage</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-speedometer2"></i></span>
                <input id="mileage" name="mileage" type="text" class="form-control" placeholder="e.g. 45,230" value="<%= _data.mileage || '' %>">
              </div>
            </div>

            <div class="col-12">
              <label for="notes" class="form-label">Inspection Notes</label>
              <textarea id="notes" name="notes" class="form-control" rows="3" placeholder="General notes about this inspection..."><%= _data.notes || '' %></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Tyres -->
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2 tyre-header">
            <h2 class="h5 mb-0">Tyres</h2>
            <div class="d-none d-md-flex gap-2">
              <span class="badge text-bg-light pos-chip">Nearside</span>
              <span class="badge text-bg-light pos-chip">Offside</span>
            </div>
          </div>
          <p class="section-help mb-3">
            Enter <span class="kbd">size</span>, tread depths (mm), PSI, brand, DOT last-4 (<span class="kbd">WWYY</span>), notes, and status. Use “Apply this tyre to all” to speed things up.
          </p>

          <% const positions = [
              { key: 'nearside.front',  label: 'Nearside • Front'  },
              { key: 'nearside.rear',   label: 'Nearside • Rear'   },
              { key: 'offside.front',   label: 'Offside • Front'   },
              { key: 'offside.rear',    label: 'Offside • Rear'    },
            ];
            const path = (k) => `tyres${k.split('.').map(p => `[${p}]`).join('')}`;
            const getVal = (obj, str) => {
              if (!obj) return '';
              return str.split('.').reduce((o, k) => (o && (k in o)) ? o[k] : '', obj) ?? '';
            };
          %>

          <div class="accordion" id="tyresAccordion">
            <% positions.forEach((pos, idx) => { 
              const paneId=`pane-${idx}`; 
              const headingId=`heading-${idx}`;
              const pre = (_data.tyres) ? getVal(_data.tyres, pos.key) : null;
            %>
              <div class="accordion-item" data-tyre="<%= pos.key %>">
                <h2 class="accordion-header" id="<%= headingId %>">
                  <button class="accordion-button <%= idx ? 'collapsed' : '' %>" type="button" data-bs-toggle="collapse" data-bs-target="#<%= paneId %>" aria-expanded="<%= idx ? 'false' : 'true' %>" aria-controls="<%= paneId %>">
                    <i class="bi bi-geo-alt me-2"></i><%= pos.label %>
                  </button>
                </h2>
                <div id="<%= paneId %>" class="accordion-collapse collapse <%= idx ? '' : 'show' %>" aria-labelledby="<%= headingId %>" data-bs-parent="#tyresAccordion">
                  <div class="accordion-body">
                    <div class="d-flex tyre-actions justify-content-end mb-2">
                      <button type="button" class="btn btn-sm btn-outline-secondary apply-this-tyre">
                        <i class="bi bi-arrow-down-up"></i> Apply this tyre to all
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-danger clear-this-tyre">
                        <i class="bi bi-eraser"></i> Clear
                      </button>
                    </div>

                    <div class="row g-3">
                      <!-- Row A: tread depths -->
                      <div class="col-12">
                        <span class="fw-600">Tread depth (mm)</span>
                        <span class="text-muted small ms-2" data-bs-toggle="tooltip" title="Measure inner, centre, and outer grooves">
                          <i class="bi bi-info-circle"></i>
                        </span>
                      </div>
                      <div class="col-12 col-md-4">
                        <label class="form-label">Inner</label>
                        <input type="number" step="0.1" min="0" class="form-control"
                          name="<%= path(pos.key) %>[treadDepth][inner]"
                          data-field="treadDepth.inner"
                          value="<%= pre && pre.treadDepth ? (pre.treadDepth.inner ?? '') : '' %>"
                          placeholder="e.g. 7.0">
                      </div>
                      <div class="col-12 col-md-4">
                        <label class="form-label">Middle</label>
                        <input type="number" step="0.1" min="0" class="form-control"
                          name="<%= path(pos.key) %>[treadDepth][middle]"
                          data-field="treadDepth.middle"
                          value="<%= pre && pre.treadDepth ? (pre.treadDepth.middle ?? '') : '' %>"
                          placeholder="e.g. 7.0">
                      </div>
                      <div class="col-12 col-md-4">
                        <label class="form-label">Outer</label>
                        <input type="number" step="0.1" min="0" class="form-control"
                          name="<%= path(pos.key) %>[treadDepth][outer]"
                          data-field="treadDepth.outer"
                          value="<%= pre && pre.treadDepth ? (pre.treadDepth.outer ?? '') : '' %>"
                          placeholder="e.g. 6.0">
                      </div>

                      <!-- Row B: size + psi + dot (6 + 3 + 3) -->
                      <div class="col-12 col-md-6">
                        <label class="form-label">Tyre Size 
                          <i class="bi bi-question-circle text-muted" data-bs-toggle="tooltip" title='Format like "205/55 R16 91V" (load+speed optional)'></i>
                        </label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="bi bi-upc-scan"></i></span>
                          <input type="text" class="form-control"
                            name="<%= path(pos.key) %>[size]"
                            data-field="size"
                            value="<%= pre ? (pre.size ?? '') : '' %>"
                            placeholder="e.g. 205/55 R16 91V"
                            pattern="\\d{3}\\/\\d{2}\\s*R\\d{2}(\\s*\\d{2,3}[A-Z])?"
                            title="Format like 205/55 R16 91V">
                        </div>
                      </div>
                      <div class="col-6 col-md-3">
                        <label class="form-label">PSI</label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="bi bi-thermometer-half"></i></span>
                          <input type="number" min="0" step="0.1" class="form-control"
                            name="<%= path(pos.key) %>[psi]"
                            data-field="psi"
                            value="<%= pre ? (pre.psi ?? '') : '' %>"
                            placeholder="e.g. 32">
                        </div>
                      </div>
                      <div class="col-6 col-md-3">
                        <label class="form-label">DOT (WWYY)
                          <i class="bi bi-question-circle text-muted" data-bs-toggle="tooltip" title="Last 4 digits only: week 01–53 + year (e.g., 0523)"></i>
                        </label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="bi bi-hash"></i></span>
                          <input type="text" class="form-control"
                            name="<%= path(pos.key) %>[dot]"
                            data-field="dot"
                            value="<%= pre ? (pre.dot ?? '') : '' %>"
                            placeholder="e.g. 0523"
                            pattern="(0[1-9]|[1-4][0-9]|5[0-3])[0-9]{2}"
                            title="Enter 4 digits: week 01–53, then year (e.g., 0523)">
                        </div>
                        <div class="form-text">Last 4 digits only (week + year).</div>
                      </div>

                      <!-- Row C: brand + status (8 + 4) -->
                      <div class="col-12 col-md-8">
                        <label class="form-label">Brand</label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="bi bi-tags"></i></span>
                          <input type="text" class="form-control"
                            name="<%= path(pos.key) %>[brand]"
                            data-field="brand"
                            value="<%= pre ? (pre.brand ?? '') : '' %>"
                            placeholder="e.g. MICHELIN CROSSCLIMATE">
                        </div>
                      </div>
                      <div class="col-12 col-md-4">
                        <label class="form-label">Status</label>
                        <select class="form-select"
                          name="<%= path(pos.key) %>[status]"
                          data-field="status">
                          <option value="">— Select —</option>
                          <option value="Good"   <%= pre && pre.status === 'Good' ? 'selected' : '' %>>Good</option>
                          <option value="Warning"<%= pre && pre.status === 'Warning' ? 'selected' : '' %>>Warning</option>
                          <option value="Bad"    <%= pre && pre.status === 'Bad' ? 'selected' : '' %>>Bad</option>
                        </select>
                      </div>

                      <!-- Row D: notes (full width) -->
                      <div class="col-12">
                        <label class="form-label">Tyre Notes</label>
                        <input type="text" class="form-control"
                          name="<%= path(pos.key) %>[notes]"
                          data-field="notes"
                          value="<%= pre ? (pre.notes ?? '') : '' %>"
                          placeholder="e.g. Bald on edges">
                      </div>
                    </div><!-- /row -->
                  </div>
                </div>
              </div>
            <% }) %>
          </div>
        </div>
      </div>

      <!-- Sticky submit bar (nice on mobile) -->
      <div class="sticky-cta">
        <div class="card shadow-sm">
          <div class="card-body d-flex flex-column flex-sm-row gap-2 justify-content-end">
            <a href="/inspections" class="btn btn-outline-secondary"><i class="bi bi-x-circle"></i> Cancel</a>
            <button class="btn btn-primary" type="submit"><i class="bi bi-check2-circle"></i> Create Inspection</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- UX helpers -->
  <script>
  // Enable tooltips (leave as-is if you already have this)
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));

  (function () {
    const form = document.querySelector('form[action="/inspections"]');

    // While typing:
    // - DOT: uppercase & no spaces, limit to 4 chars
    // - SIZE: uppercase & collapse multiple internal spaces to one
    //   (NO trim here, so a trailing space is allowed while typing)
    document.addEventListener('input', (e) => {
      const el = e.target;
      if (!(el instanceof HTMLInputElement)) return;

      if (el.name?.endsWith('[dot]')) {
        el.value = el.value.replace(/\s+/g, '').toUpperCase().slice(0, 4);
      }

      if (el.name?.endsWith('[size]')) {
        const pos = el.selectionStart;
        let v = el.value.toUpperCase().replace(/[ ]{2,}/g, ' '); // collapse 2+ spaces to 1
        el.value = v;
        try { el.setSelectionRange(pos, pos); } catch {}
      }
    });

    // On blur: do full normalisation for SIZE
    document.addEventListener('blur', (e) => {
      const el = e.target;
      if (!(el instanceof HTMLInputElement)) return;
      if (!el.name?.endsWith('[size]')) return;

      let v = el.value.toUpperCase().replace(/\s+/g, ' ').trim(); // now OK to trim
      v = v.replace(/R\s*(\d{2})/i, 'R$1');                       // no space after R
      v = v.replace(/(\d{3}\/\d{2})\s*R(\d{2})/i, '$1 R$2');      // exactly one space before R
      el.value = v;
    }, true);

    // On submit: ensure every SIZE is normalised once
    form?.addEventListener('submit', () => {
      document.querySelectorAll('input[name$="[size]"]').forEach((el) => {
        let v = el.value.toUpperCase().replace(/\s+/g, ' ').trim();
        v = v.replace(/R\s*(\d{2})/i, 'R$1');
        v = v.replace(/(\d{3}\/\d{2})\s*R(\d{2})/i, '$1 R$2');
        el.value = v;
      });
    });
  })();
</script>

</body>
</html>
