<!-- views/inspections/new.ejs -->
<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
  <head>
    <%- include('../partials/head', { title: 'New Inspection — Tyre Inspector' }) %>
    <link rel="stylesheet" href="/css/new-inspection.css">
  </head>
  <body class="h-full">
    <%- include('../partials/header-mobile') %>

    <div class="md:pl-64">
      <%- include('../partials/sidebar', { active: 'inspections', user }) %>

      <main class="max-w-6xl mx-auto px-4 md:px-8 py-6">
        <!-- Header -->
        <header class="mb-6">
          <div class="flex items-center justify-between">
            <div>
              <h1 class="text-2xl font-bold text-slate-900">New Inspection</h1>
              <div class="text-sm text-slate-600 mt-1">
                <%= vehicle.make %> <%= vehicle.model %> (<%= vehicle.year %>)
                <% if (vehicle.torque) { %> • <%= vehicle.torque %> Nm<% } %>
                <% if (mileage) { %> • <strong>Mileage:</strong> <%= mileage %><% } %>
              </div>
            </div>
            <span class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-mono text-slate-800 shadow-sm">
              <%= vehicle.vrm %>
            </span>
          </div>
        </header>

        <% /* ---------- EJS helpers (DRY names & options) ---------- */ %>
        <%
          const PATHS = { osf:'offside.front', nsf:'nearside.front', osr:'offside.rear', nsr:'nearside.rear' };
          const path = function (k, field) { return PATHS[k] + '.' + field; };

          // Tread depth options (8 -> 2 step 0.5, plus 1.6)
          const TREADS = [];
          for (let v = 8.0; v >= 2.0; v -= 0.5) { TREADS.push(v % 1 ? v.toFixed(1) : v.toFixed(0)); }
          TREADS.push('1.6');

          const QUICK_TAGS = [
            'Bald on inner edge','Bald on outer edge','Perished','Bulge','Puncture','Uneven wear','Cracked sidewall','Cord exposed'
          ];

          const panels = [
            { key:'osf', title:'Offside Front (OSF)',  sizeDefault: defaults.frontSize },
            { key:'nsf', title:'Nearside Front (NSF)', sizeDefault: defaults.frontSize },
            { key:'osr', title:'Offside Rear (OSR)',   sizeDefault: defaults.rearSize  },
            { key:'nsr', title:'Nearside Rear (NSR)',  sizeDefault: defaults.rearSize  }
          ];

          const LABELS = {
            osf: 'Offside Front (OSF)',
            nsf: 'Nearside Front (NSF)',
            osr: 'Offside Rear (OSR)',
            nsr: 'Nearside Rear (NSR)'
          };
        %>

        <form method="POST" action="/inspections" id="inspection-form" class="space-y-6" novalidate>
          <input type="hidden" name="vrm" value="<%= vehicle.vrm %>" />
          <input type="hidden" name="mileage" value="<%= mileage || '' %>" />

          <!-- Ready banner (appears when all done) -->
          <div id="complete-banner" class="hidden rounded-xl border border-emerald-200 bg-emerald-50 text-emerald-800 px-4 py-3 text-sm flex items-center gap-2">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M9 12l2 2 4-4"/><path d="M12 22C6.5 22 2 17.5 2 12S6.5 2 12 2s10 4.5 10 10-4.5 10-10 10Z" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
            All wheels complete — add notes and save.
          </div>

          <!-- Workspace -->
          <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
            <!-- LEFT: Car / wheel picker -->
            <section id="pick-screen" class="lg:col-span-3 rounded-xl border border-slate-200 bg-white shadow-sm" aria-labelledby="pick-heading">
              <div class="px-4 py-3 border-b border-slate-200 font-semibold text-slate-900" id="pick-heading">Select a wheel</div>
              <div class="p-4">
                <div class="car-wrap" aria-hidden="true">
                  <svg class="car-svg" viewBox="0 0 400 800" xmlns="http://www.w3.org/2000/svg">
                    <rect x="60" y="60" width="280" height="680" rx="40" fill="#f1f3f5" stroke="#ced4da" />
                    <rect x="80" y="80" width="240" height="120" rx="20" fill="#e9ecef" />
                    <rect x="80" y="600" width="240" height="120" rx="20" fill="#e9ecef" />
                    <rect x="90" y="240" width="220" height="280" rx="16" fill="#dee2e6" />
                    <line x1="60" y1="400" x2="340" y2="400" stroke="#ced4da" stroke-dasharray="4 6" />
                  </svg>

                  <button type="button" class="wheel-hotspot" data-key="osf" style="left: 86%; top: 19%;">OSF</button>
                  <button type="button" class="wheel-hotspot" data-key="nsf" style="left: 14%; top: 19%;">NSF</button>
                  <button type="button" class="wheel-hotspot" data-key="osr" style="left: 86%; top: 81%;">OSR</button>
                  <button type="button" class="wheel-hotspot" data-key="nsr" style="left: 14%; top: 81%;">NSR</button>
                </div>
                <p class="mt-3 text-xs text-slate-500">
                  Use the copy button to copy DOT, Brand &amp; Model to other wheels.
                </p>
              </div>
            </section>
            <!-- CENTER: Panels -->
            <div id="panels-wrapper" class="lg:col-span-6 space-y-6 lg:space-y-0">
              <% panels.forEach(function(p){ %>
                <section id="panel-<%= p.key %>" class="hidden" aria-labelledby="panel-title-<%= p.key %>">
                  <div class="rounded-xl border border-slate-200 bg-white shadow-sm">
                    <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
                      <h2 id="panel-title-<%= p.key %>" class="text-sm font-semibold text-slate-900"><%= p.title %></h2>

                      <!-- Copy button -->
                      <div class="flex items-center gap-2">
                        <span id="copy-pill-<%= p.key %>" class="hidden text-xs rounded-full bg-emerald-100 text-emerald-800 px-2 py-0.5">Copied!</span>
                        <button
                          type="button"
                          title="Copy DOT, Brand & Model to other wheels"
                          class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-2.5 py-2 text-slate-700 hover:bg-slate-50 transition-colors"
                          data-copy-all-from="<%= p.key %>"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                            <rect x="9" y="9" width="13" height="13" rx="2" stroke-width="1.6"></rect>
                            <rect x="2" y="2" width="13" height="13" rx="2" stroke-width="1.6"></rect>
                          </svg>
                        </button>
                      </div>
                    </div>

                    <div class="p-6">
                      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Size + DOT row -->
                        <div class="sm:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                          <!-- Size -->
                          <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1" for="size-<%= p.key %>">Size</label>
                            <input
                              id="size-<%= p.key %>"
                              name="<%= path(p.key,'size') %>"
                              class="w-full rounded-lg border border-slate-300 px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 tyre-field"
                              data-tyre-key="<%= p.key %>"
                              value="<%= p.sizeDefault %>"
                              placeholder="e.g. 225/45R17 91W"
                            />
                          </div>

                          <!-- DOT -->
                          <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1" for="dot-<%= p.key %>">DOT</label>
                            <input
                              id="dot-<%= p.key %>"
                              name="<%= path(p.key,'dot') %>"
                              class="w-full rounded-lg border border-slate-300 px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 tyre-field"
                              data-tyre-key="<%= p.key %>"
                              placeholder="e.g. 2423"
                            />
                          </div>
                        </div>

                        <!-- Brand (autocomplete) -->
                        <div>
                          <label class="block text-sm font-medium text-slate-700 mb-1" for="brand-<%= p.key %>">Brand</label>
                          <input
                            id="brand-<%= p.key %>"
                            list="brands-list"
                            class="brand-input w-full rounded-lg border border-slate-300 px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 tyre-field"
                            data-tyre-key="<%= p.key %>"
                            name="<%= path(p.key,'brand') %>"
                            placeholder="Start typing brand…"
                            autocomplete="off"
                          />
                        </div>

                        <!-- Model (autocomplete, depends on brand) -->
                        <div>
                          <label class="block text-sm font-medium text-slate-700 mb-1" for="model-<%= p.key %>">Model</label>
                          <input
                            id="model-<%= p.key %>"
                            list="models-<%= p.key %>"
                            class="model-input w-full rounded-lg border border-slate-300 px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 tyre-field"
                            data-tyre-key="<%= p.key %>"
                            name="<%= path(p.key,'model') %>"
                            placeholder="Select or type model…"
                            autocomplete="off"
                          />
                          <datalist id="models-<%= p.key %>"><!-- filled dynamically --></datalist>
                        </div>

                        <!-- Tread depth -->
                        <div class="sm:col-span-2">
                          <label class="block text-sm font-medium text-slate-700 mb-2">Tread depth (mm)</label>
                          <div class="grid grid-cols-3 gap-3">
                            <div>
                              <label class="block text-xs text-slate-500 mb-1">Inner</label>
                              <select class="w-full rounded-lg border border-slate-300 px-3 py-2.5 bg-white text-center focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 tyre-field"
                                      data-tyre-key="<%= p.key %>" name="<%= path(p.key,'treadDepth.inner') %>">
                                <option value="">-</option>
                                <% TREADS.forEach(function(v){ %><option value="<%= v %>"><%= v %></option><% }) %>
                              </select>
                            </div>
                            <div>
                              <label class="block text-xs text-slate-500 mb-1">Middle</label>
                              <select class="w-full rounded-lg border border-slate-300 px-3 py-2.5 bg-white text-center focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 tyre-field"
                                      data-tyre-key="<%= p.key %>" name="<%= path(p.key,'treadDepth.middle') %>">
                                <option value="">-</option>
                                <% TREADS.forEach(function(v){ %><option value="<%= v %>"><%= v %></option><% }) %>
                              </select>
                            </div>
                            <div>
                              <label class="block text-xs text-slate-500 mb-1">Outer</label>
                              <select class="w-full rounded-lg border border-slate-300 px-3 py-2.5 bg-white text-center focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 tyre-field"
                                      data-tyre-key="<%= p.key %>" name="<%= path(p.key,'treadDepth.outer') %>">
                                <option value="">-</option>
                                <% TREADS.forEach(function(v){ %><option value="<%= v %>"><%= v %></option><% }) %>
                              </select>
                            </div>
                          </div>
                          <p class="mt-2 text-xs text-slate-500">Select one value and the others auto-fill if blank.</p>
                        </div>

                        <!-- Tags -->
                        <div class="sm:col-span-2">
                          <label class="block text-sm font-medium text-slate-700 mb-2">Tags</label>
                          <div class="flex flex-wrap gap-2">
                            <% QUICK_TAGS.forEach(function(tag){
                                 var id = (p.key + '-tag-' + tag.replace(/[^a-z0-9]+/gi,'-').toLowerCase());
                            %>
                              <label class="chip inline-flex items-center gap-1" for="<%= id %>">
                                <input id="<%= id %>" type="checkbox" class="hidden tag-input" name="<%= path(p.key,'tags') %>" value="<%= tag %>" />
                                <span class="text-sm"><%= tag %></span>
                              </label>
                            <% }) %>
                          </div>
                        </div>
                      </div>

                      <!-- Footer actions (full-width Save on mobile only) -->
                      <div class="mt-6 block lg:hidden">
                        <button type="button" class="w-full inline-flex items-center justify-center rounded-lg bg-sky-600 px-4 py-3 text-white font-semibold hover:bg-sky-700 transition-colors"
                                data-save-back="<%= p.key %>">
                          Save <%= p.key.toUpperCase() %>
                        </button>
                      </div>
                    </div>
                  </div>
                </section>
              <% }) %>
            </div>
            <!-- RIGHT: Sticky Review & Save (desktop only) -->
            <aside id="review-aside" class="hidden lg:block lg:col-span-3">
              <div class="sticky top-4 space-y-4">
                <div class="rounded-xl border border-slate-200 bg-white shadow-sm">
                  <div class="px-4 py-3 border-b border-slate-200 font-semibold text-slate-900">Review &amp; Save</div>
                  <div class="p-4">
                    <!-- Progress list -->
                    <ul id="review-list" class="space-y-3 text-sm">
                      <li id="review-osf" class="flex items-center justify-between">
                        <span class="text-slate-700"><%= LABELS.osf %></span>
                        <span class="badge inline-flex items-center rounded-full px-2 py-0.5 text-xs bg-slate-100 text-slate-700">Pending</span>
                      </li>
                      <li id="review-nsf" class="flex items-center justify-between">
                        <span class="text-slate-700"><%= LABELS.nsf %></span>
                        <span class="badge inline-flex items-center rounded-full px-2 py-0.5 text-xs bg-slate-100 text-slate-700">Pending</span>
                      </li>
                      <li id="review-osr" class="flex items-center justify-between">
                        <span class="text-slate-700"><%= LABELS.osr %></span>
                        <span class="badge inline-flex items-center rounded-full px-2 py-0.5 text-xs bg-slate-100 text-slate-700">Pending</span>
                      </li>
                      <li id="review-nsr" class="flex items-center justify-between">
                        <span class="text-slate-700"><%= LABELS.nsr %></span>
                        <span class="badge inline-flex items-center rounded-full px-2 py-0.5 text-xs bg-slate-100 text-slate-700">Pending</span>
                      </li>
                    </ul>

                    <!-- Notes (proxy; syncs with real notes field) -->
                    <div class="mt-6">
                      <label for="notes-proxy" class="block text-sm font-medium text-slate-700 mb-1">Notes</label>
                      <textarea id="notes-proxy" rows="4"
                        class="w-full rounded-lg border border-slate-300 px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                        placeholder="Overall findings, advisories, etc."></textarea>
                      <p class="mt-1 text-xs text-slate-500">These notes save with the report.</p>
                    </div>

                    <!-- Desktop Save -->
                    <button id="desktop-save-btn" form="inspection-form" disabled
                      class="mt-4 w-full inline-flex items-center justify-center rounded-lg bg-emerald-600/50 px-4 py-3 text-white text-base font-semibold cursor-not-allowed transition-colors">
                      Save inspection
                    </button>
                    <p id="desktop-save-hint" class="mt-2 text-xs text-slate-500">Complete all 4 wheels to enable saving.</p>
                  </div>
                </div>
              </div>
            </aside>
          </div>

          <!-- Real notes + Save (mobile only; hidden on lg to avoid duplication) -->
          <div id="notes-block" class="hidden lg:hidden">
            <label for="notes" class="block text-sm font-medium text-slate-700 mb-1">General notes</label>
            <textarea id="notes" name="notes" rows="3"
              class="w-full rounded-lg border border-slate-300 px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
              placeholder="Overall findings, advisories, etc."></textarea>
          </div>

          <div id="save-block" class="hidden lg:hidden">
            <button class="w-full inline-flex items-center justify-center rounded-lg bg-emerald-600 px-4 py-3 text-white text-base font-semibold hover:bg-emerald-700 transition-colors focus:outline-none focus:ring-2 focus:ring-emerald-500">
              Save inspection
            </button>
          </div>
        </form>
      </main>
    </div>

    <!-- Sticky Save (mobile only, appears when complete) -->
    <div id="save-sticky" class="hidden lg:hidden fixed inset-x-0 bottom-0 z-40 border-t border-slate-200 bg-white/90 backdrop-blur p-3">
      <div class="mx-auto max-w-6xl">
        <button form="inspection-form"
          class="w-full inline-flex items-center justify-center rounded-lg bg-emerald-600 px-4 py-3 text-white text-base font-semibold hover:bg-emerald-700 transition-colors focus:outline-none focus:ring-2 focus:ring-emerald-500">
          Save inspection
        </button>
      </div>
    </div>

    <!-- Shared brand datalist (autocomplete source) -->
    <datalist id="brands-list">
      <% (brandOptions || []).forEach(function(b){ %>
        <option value="<%= b %>"></option>
      <% }) %>
    </datalist>
    <script src="/js/new-inspection.js"></script>
  </body>
</html>
