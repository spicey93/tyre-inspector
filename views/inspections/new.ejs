<!-- views/inspections/new.ejs -->
<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>New Inspection</title>

    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      /* Car + wheels */
      .car-wrap { position: relative; max-width: 200px; margin-inline: auto; }
      @media (min-width: 576px){ .car-wrap { max-width: 220px; } }
      @media (min-width: 992px){ .car-wrap { max-width: 260px; } }
      .car-svg { width: 100%; height: auto; display: block; }

      .wheel-hotspot{
        position: absolute; width: 22%; aspect-ratio: 1/1; border-radius: 9999px;
        transform: translate(-50%, -50%);
        border: 2px solid rgb(173,181,189); background: #fff;
        display: flex; align-items: center; justify-content: center;
        font-weight: 700; font-size: .8rem;
        transition: box-shadow .15s, transform .05s, border-color .15s, background-color .15s, color .15s;
        cursor: pointer; user-select: none;
      }
      .wheel-hotspot.active{ box-shadow: inset 0 0 0 .45rem rgba(13,110,253,.25); }

      /* Condition colours (applied ONLY when completed) */
      .wheel-hotspot.cond-ok   { border-color:#15803d; background:#e6f4ea; color:#14532d; }
      .wheel-hotspot.cond-adv  { border-color:#f59e0b; background:#fff7d6; color:#7c5206; }
      .wheel-hotspot.cond-fail { border-color:#e11d48; background:#fde2e4; color:#7f1d1d; }

      /* Tag chips */
      .chip{ border:1px solid rgb(203 213 225); border-radius:9999px; padding:.25rem .6rem; cursor:pointer; user-select:none; }
      .chip.active{ background:#e7f1ff; border-color:#9ec5fe; }

      /* Copy feedback flash */
      .flash-updated{ box-shadow:0 0 0 .55rem rgba(16,185,129,.28) inset !important; }
    </style>
  </head>
  <body class="h-full">
    <div class="mx-auto max-w-6xl px-4 py-6">
      <a href="/" class="inline-flex items-center gap-2 text-slate-600 hover:text-slate-800 mb-3">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M15 19l-7-7 7-7" /></svg>
        Home
      </a>

      <!-- Header -->
      <header class="mb-4">
        <div class="flex items-center justify-between">
          <h1 class="text-lg font-semibold text-slate-900">New Inspection</h1>
          <span class="inline-flex items-center rounded-md border border-slate-300 bg-white px-2.5 py-1 text-sm font-mono text-slate-800">
            <%= vehicle.vrm %>
          </span>
        </div>
        <div class="text-sm text-slate-600 mt-1">
          <%= vehicle.make %> <%= vehicle.model %> (<%= vehicle.year %>)
          <% if (vehicle.torque) { %> • <%= vehicle.torque %> Nm<% } %>
          <% if (mileage) { %> • <strong>Mileage:</strong> <%= mileage %><% } %>
        </div>
      </header>

      <% /* ---------- EJS helpers (DRY names & options) ---------- */ %>
      <%
        const PATHS = { osf:'offside.front', nsf:'nearside.front', osr:'offside.rear', nsr:'nearside.rear' };
        const path = function (k, field) { return PATHS[k] + '.' + field; };

        // Tread depth options (8 -> 2 step 0.5, plus 1.6)
        const TREADS = [];
        for (let v = 8.0; v >= 2.0; v -= 0.5) { TREADS.push(v % 1 ? v.toFixed(1) : v.toFixed(0)); }
        TREADS.push('1.6');

        const QUICK_TAGS = [
          'Bald on inner edge','Bald on outer edge','Perished','Bulge','Puncture','Uneven wear','Cracked sidewall','Cord exposed'
        ];

        const panels = [
          { key:'osf', title:'Offside Front (OSF)',  sizeDefault: defaults.frontSize },
          { key:'nsf', title:'Nearside Front (NSF)', sizeDefault: defaults.frontSize },
          { key:'osr', title:'Offside Rear (OSR)',   sizeDefault: defaults.rearSize  },
          { key:'nsr', title:'Nearside Rear (NSR)',  sizeDefault: defaults.rearSize  }
        ];

        const LABELS = {
          osf: 'Offside Front (OSF)',
          nsf: 'Nearside Front (NSF)',
          osr: 'Offside Rear (OSR)',
          nsr: 'Nearside Rear (NSR)'
        };
      %>

      <form method="POST" action="/inspections" id="inspection-form" class="space-y-4" novalidate>
        <input type="hidden" name="vrm" value="<%= vehicle.vrm %>" />
        <input type="hidden" name="mileage" value="<%= mileage || '' %>" />

        <!-- Ready banner (appears when all done) -->
        <div id="complete-banner" class="hidden rounded-xl border border-emerald-200 bg-emerald-50 text-emerald-800 px-3 py-2 text-sm flex items-center gap-2">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M9 12l2 2 4-4"/><path d="M12 22C6.5 22 2 17.5 2 12S6.5 2 12 2s10 4.5 10 10-4.5 10-10 10Z" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
          All wheels complete — add notes and save.
        </div>

        <!-- Workspace -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 items-start">
          <!-- LEFT: Car / wheel picker -->
          <section id="pick-screen" class="lg:col-span-3 rounded-2xl border border-slate-200 bg-white shadow" aria-labelledby="pick-heading">
            <div class="px-4 py-3 border-b border-slate-200 font-semibold" id="pick-heading">Select a wheel to enter details</div>
            <div class="p-4">
              <div class="car-wrap" aria-hidden="true">
                <svg class="car-svg" viewBox="0 0 400 800" xmlns="http://www.w3.org/2000/svg">
                  <rect x="60" y="60" width="280" height="680" rx="40" fill="#f1f3f5" stroke="#ced4da" />
                  <rect x="80" y="80" width="240" height="120" rx="20" fill="#e9ecef" />
                  <rect x="80" y="600" width="240" height="120" rx="20" fill="#e9ecef" />
                  <rect x="90" y="240" width="220" height="280" rx="16" fill="#dee2e6" />
                  <line x1="60" y1="400" x2="340" y2="400" stroke="#ced4da" stroke-dasharray="4 6" />
                </svg>

                <button type="button" class="wheel-hotspot" data-key="osf" style="left: 86%; top: 19%;">OSF</button>
                <button type="button" class="wheel-hotspot" data-key="nsf" style="left: 14%; top: 19%;">NSF</button>
                <button type="button" class="wheel-hotspot" data-key="osr" style="left: 86%; top: 81%;">OSR</button>
                <button type="button" class="wheel-hotspot" data-key="nsr" style="left: 14%; top: 81%;">NSR</button>
              </div>
              <p class="mt-2 text-xs text-slate-500">
                Use the header copy button to copy DOT, Brand &amp; Model (size only copies into empty size fields).
              </p>
            </div>
          </section>
          <!-- CENTER: Panels -->
          <div id="panels-wrapper" class="lg:col-span-6 space-y-4 lg:space-y-0">
            <% panels.forEach(function(p){ %>
              <section id="panel-<%= p.key %>" class="hidden" aria-labelledby="panel-title-<%= p.key %>">
                <div class="rounded-2xl border border-slate-200 bg-white shadow">
                  <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
                    <h2 id="panel-title-<%= p.key %>" class="text-sm font-semibold text-slate-900"><%= p.title %></h2>

                    <!-- Copy button -->
                    <div class="flex items-center gap-2">
                      <span id="copy-pill-<%= p.key %>" class="hidden text-xs rounded-full bg-emerald-100 text-emerald-800 px-2 py-0.5">Copied!</span>
                      <button
                        type="button"
                        title="Copy DOT, Brand & Model to other wheels not yet treaded (won’t overwrite an existing Size)"
                        class="inline-flex items-center rounded-md border border-slate-300 bg-white px-2.5 py-2 text-slate-700 hover:bg-slate-50"
                        data-copy-all-from="<%= p.key %>"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                          <rect x="9" y="9" width="13" height="13" rx="2" stroke-width="1.6"></rect>
                          <rect x="2" y="2" width="13" height="13" rx="2" stroke-width="1.6"></rect>
                        </svg>
                      </button>
                    </div>
                  </div>

                  <div class="p-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                      <!-- Size + DOT row -->
                      <div class="sm:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-3">
                        <!-- Size -->
                        <div>
                          <label class="block text-sm font-medium text-slate-700" for="size-<%= p.key %>">Size</label>
                          <input
                            id="size-<%= p.key %>"
                            name="<%= path(p.key,'size') %>"
                            class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500 tyre-field"
                            data-tyre-key="<%= p.key %>"
                            value="<%= p.sizeDefault %>"
                            placeholder="e.g. 225/45R17 91W"
                          />
                        </div>

                        <!-- DOT -->
                        <div>
                          <label class="block text-sm font-medium text-slate-700" for="dot-<%= p.key %>">DOT</label>
                          <input
                            id="dot-<%= p.key %>"
                            name="<%= path(p.key,'dot') %>"
                            class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500 tyre-field"
                            data-tyre-key="<%= p.key %>"
                            placeholder="e.g. 2423"
                          />
                        </div>
                      </div>

                      <!-- Brand (autocomplete) -->
                      <div>
                        <label class="block text-sm font-medium text-slate-700" for="brand-<%= p.key %>">Brand</label>
                        <input
                          id="brand-<%= p.key %>"
                          list="brands-list"
                          class="brand-input mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-sky-500 tyre-field"
                          data-tyre-key="<%= p.key %>"
                          name="<%= path(p.key,'brand') %>"
                          placeholder="Start typing brand…"
                          autocomplete="off"
                        />
                      </div>

                      <!-- Model (autocomplete, depends on brand) -->
                      <div>
                        <label class="block text-sm font-medium text-slate-700" for="model-<%= p.key %>">Model</label>
                        <input
                          id="model-<%= p.key %>"
                          list="models-<%= p.key %>"
                          class="model-input mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-sky-500 tyre-field"
                          data-tyre-key="<%= p.key %>"
                          name="<%= path(p.key,'model') %>"
                          placeholder="Select or type model…"
                          autocomplete="off"
                        />
                        <datalist id="models-<%= p.key %>"><!-- filled dynamically --></datalist>
                      </div>

                      <!-- Tread depth -->
                      <div class="sm:col-span-2">
                        <label class="block text-sm font-medium text-slate-700">Tread depth (in, mid, out)</label>
                        <div class="mt-1 grid grid-cols-3 gap-2">
                          <select class="w-full rounded-lg border border-slate-300 px-2 py-2 bg-white text-center focus:outline-none focus:ring-2 focus:ring-sky-500 tyre-field"
                                  data-tyre-key="<%= p.key %>" name="<%= path(p.key,'treadDepth.inner') %>">
                            <option value="">Inner</option>
                            <% TREADS.forEach(function(v){ %><option value="<%= v %>"><%= v %> mm</option><% }) %>
                          </select>
                          <select class="w-full rounded-lg border border-slate-300 px-2 py-2 bg-white text-center focus:outline-none focus:ring-2 focus:ring-sky-500 tyre-field"
                                  data-tyre-key="<%= p.key %>" name="<%= path(p.key,'treadDepth.middle') %>">
                            <option value="">Middle</option>
                            <% TREADS.forEach(function(v){ %><option value="<%= v %>"><%= v %> mm</option><% }) %>
                          </select>
                          <select class="w-full rounded-lg border border-slate-300 px-2 py-2 bg-white text-center focus:outline-none focus:ring-2 focus:ring-sky-500 tyre-field"
                                  data-tyre-key="<%= p.key %>" name="<%= path(p.key,'treadDepth.outer') %>">
                            <option value="">Outer</option>
                            <% TREADS.forEach(function(v){ %><option value="<%= v %>"><%= v %> mm</option><% }) %>
                          </select>
                        </div>
                        <p class="mt-1 text-xs text-slate-500">Select one value and the others auto-fill if blank.</p>
                      </div>

                      <!-- Tags -->
                      <div class="sm:col-span-2">
                        <label class="block text-sm font-medium text-slate-700">Tags</label>
                        <div class="mt-1 flex flex-wrap gap-2">
                          <% QUICK_TAGS.forEach(function(tag){
                               var id = (p.key + '-tag-' + tag.replace(/[^a-z0-9]+/gi,'-').toLowerCase());
                          %>
                            <label class="chip inline-flex items-center gap-1" for="<%= id %>">
                              <input id="<%= id %>" type="checkbox" class="hidden tag-input" name="<%= path(p.key,'tags') %>" value="<%= tag %>" />
                              <span class="text-sm"><%= tag %></span>
                            </label>
                          <% }) %>
                        </div>
                      </div>
                    </div>

                    <!-- Footer actions (full-width Save on mobile only) -->
                    <div class="mt-4 block lg:hidden">
                      <button type="button" class="w-full inline-flex items-center justify-center rounded-lg bg-sky-600 px-4 py-2.5 text-white font-semibold hover:bg-sky-700"
                              data-save-back="<%= p.key %>">
                        Save <%= p.key.toUpperCase() %>
                      </button>
                    </div>
                  </div>
                </div>
              </section>
            <% }) %>
          </div>
          <!-- RIGHT: Sticky Review & Save (desktop only) -->
          <aside id="review-aside" class="hidden lg:block lg:col-span-3">
            <div class="sticky top-4 space-y-4">
              <div class="rounded-2xl border border-slate-200 bg-white shadow">
                <div class="px-4 py-3 border-b border-slate-200 font-semibold">Review &amp; Save</div>
                <div class="p-4">
                  <!-- Progress list -->
                  <ul id="review-list" class="space-y-2 text-sm">
                    <li id="review-osf" class="flex items-center justify-between">
                      <span><%= LABELS.osf %></span>
                      <span class="badge inline-flex items-center rounded-full px-2 py-0.5 text-xs bg-slate-100 text-slate-700">Pending</span>
                    </li>
                    <li id="review-nsf" class="flex items-center justify-between">
                      <span><%= LABELS.nsf %></span>
                      <span class="badge inline-flex items-center rounded-full px-2 py-0.5 text-xs bg-slate-100 text-slate-700">Pending</span>
                    </li>
                    <li id="review-osr" class="flex items-center justify-between">
                      <span><%= LABELS.osr %></span>
                      <span class="badge inline-flex items-center rounded-full px-2 py-0.5 text-xs bg-slate-100 text-slate-700">Pending</span>
                    </li>
                    <li id="review-nsr" class="flex items-center justify-between">
                      <span><%= LABELS.nsr %></span>
                      <span class="badge inline-flex items-center rounded-full px-2 py-0.5 text-xs bg-slate-100 text-slate-700">Pending</span>
                    </li>
                  </ul>

                  <!-- Notes (proxy; syncs with real notes field) -->
                  <div class="mt-4">
                    <label for="notes-proxy" class="block text-sm font-medium text-slate-700">Notes</label>
                    <textarea id="notes-proxy" rows="5"
                      class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                      placeholder="Overall findings, advisories, etc."></textarea>
                    <p class="mt-1 text-xs text-slate-500">These notes save with the report.</p>
                  </div>

                  <!-- Desktop Save -->
                  <button id="desktop-save-btn" form="inspection-form" disabled
                    class="mt-4 w-full inline-flex items-center justify-center rounded-xl bg-emerald-600/50 px-4 py-3 text-white text-base font-semibold cursor-not-allowed">
                    Save inspection
                  </button>
                  <p id="desktop-save-hint" class="mt-2 text-xs text-slate-500">Complete all 4 wheels to enable saving.</p>
                </div>
              </div>
            </div>
          </aside>
        </div>

        <!-- Real notes + Save (mobile only; hidden on lg to avoid duplication) -->
        <div id="notes-block" class="hidden lg:hidden">
          <label for="notes" class="block text-sm font-medium text-slate-700">General notes</label>
          <textarea id="notes" name="notes" rows="3"
            class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
            placeholder="Overall findings, advisories, etc."></textarea>
        </div>

        <div id="save-block" class="hidden lg:hidden">
          <button class="w-full inline-flex items-center justify-center rounded-xl bg-emerald-600 px-4 py-3 text-white text-base font-semibold hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500">
            Save inspection
          </button>
        </div>
      </form>
    </div>

    <!-- Sticky Save (mobile only, appears when complete) -->
    <div id="save-sticky" class="hidden lg:hidden fixed inset-x-0 bottom-0 z-40 border-t border-slate-200 bg-white/90 backdrop-blur p-3">
      <div class="mx-auto max-w-6xl">
        <button form="inspection-form"
          class="w-full inline-flex items-center justify-center rounded-xl bg-emerald-600 px-4 py-3 text-white text-base font-semibold hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500">
          Save inspection
        </button>
      </div>
    </div>

    <!-- Shared brand datalist (autocomplete source) -->
    <datalist id="brands-list">
      <% (brandOptions || []).forEach(function(b){ %>
        <option value="<%= b %>"></option>
      <% }) %>
    </datalist>
    <script src="/js/new-inspection.js"></script>
  </body>
</html>
